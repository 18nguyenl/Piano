/** @module midi/PhysicalPiano */

const StatusBytes = {
  function: {
    "128": "Chan 1 Note off",
    "129": "Chan 2 Note off",
    "130": "Chan 3 Note off",
    "131": "Chan 4 Note off",
    "132": "Chan 5 Note off",
    "133": "Chan 6 Note off",
    "134": "Chan 7 Note off",
    "135": "Chan 8 Note off",
    "136": "Chan 9 Note off",
    "137": "Chan 10 Note off",
    "138": "Chan 11 Note off",
    "139": "Chan 12 Note off",
    "140": "Chan 13 Note off",
    "141": "Chan 14 Note off",
    "142": "Chan 15 Note off",
    "143": "Chan 16 Note off",
    "144": "Chan 1 Note on",
    "145": "Chan 2 Note on",
    "146": "Chan 3 Note on",
    "147": "Chan 4 Note on",
    "148": "Chan 5 Note on",
    "149": "Chan 6 Note on",
    "150": "Chan 7 Note on",
    "151": "Chan 8 Note on",
    "152": "Chan 9 Note on",
    "153": "Chan 10 Note on",
    "154": "Chan 11 Note on",
    "155": "Chan 12 Note on",
    "156": "Chan 13 Note on",
    "157": "Chan 14 Note on",
    "158": "Chan 15 Note on",
    "159": "Chan 16 Note on",
    "160": "Chan 1 Polyphonic Aftertouch",
    "161": "Chan 2 Polyphonic Aftertouch",
    "162": "Chan 3 Polyphonic Aftertouch",
    "163": "Chan 4 Polyphonic Aftertouch",
    "164": "Chan 5 Polyphonic Aftertouch",
    "165": "Chan 6 Polyphonic Aftertouch",
    "166": "Chan 7 Polyphonic Aftertouch",
    "167": "Chan 8 Polyphonic Aftertouch",
    "168": "Chan 9 Polyphonic Aftertouch",
    "169": "Chan 10 Polyphonic Aftertouch",
    "170": "Chan 11 Polyphonic Aftertouch",
    "171": "Chan 12 Polyphonic Aftertouch",
    "172": "Chan 13 Polyphonic Aftertouch",
    "173": "Chan 14 Polyphonic Aftertouch",
    "174": "Chan 15 Polyphonic Aftertouch",
    "175": "Chan 16 Polyphonic Aftertouch",
    "176": "Chan 1 Control/Mode Change",
    "177": "Chan 2 Control/Mode Change",
    "178": "Chan 3 Control/Mode Change",
    "179": "Chan 4 Control/Mode Change",
    "180": "Chan 5 Control/Mode Change",
    "181": "Chan 6 Control/Mode Change",
    "182": "Chan 7 Control/Mode Change",
    "183": "Chan 8 Control/Mode Change",
    "184": "Chan 9 Control/Mode Change",
    "185": "Chan 10 Control/Mode Change",
    "186": "Chan 11 Control/Mode Change",
    "187": "Chan 12 Control/Mode Change",
    "188": "Chan 13 Control/Mode Change",
    "189": "Chan 14 Control/Mode Change",
    "190": "Chan 15 Control/Mode Change",
    "191": "Chan 16 Control/Mode Change",
    "192": "Chan 1 Program Change",
    "193": "Chan 2 Program Change",
    "194": "Chan 3 Program Change",
    "195": "Chan 4 Program Change",
    "196": "Chan 5 Program Change",
    "197": "Chan 6 Program Change",
    "198": "Chan 7 Program Change",
    "199": "Chan 8 Program Change",
    "200": "Chan 9 Program Change",
    "201": "Chan 10 Program Change",
    "202": "Chan 11 Program Change",
    "203": "Chan 12 Program Change",
    "204": "Chan 13 Program Change",
    "205": "Chan 14 Program Change",
    "206": "Chan 15 Program Change",
    "207": "Chan 16 Program Change",
    "208": "Chan 1 Channel Aftertouch",
    "209": "Chan 2 Channel Aftertouch",
    "210": "Chan 3 Channel Aftertouch",
    "211": "Chan 4 Channel Aftertouch",
    "212": "Chan 5 Channel Aftertouch",
    "213": "Chan 6 Channel Aftertouch",
    "214": "Chan 7 Channel Aftertouch",
    "215": "Chan 8 Channel Aftertouch",
    "216": "Chan 9 Channel Aftertouch",
    "217": "Chan 10 Channel Aftertouch",
    "218": "Chan 11 Channel Aftertouch",
    "219": "Chan 12 Channel Aftertouch",
    "220": "Chan 13 Channel Aftertouch",
    "221": "Chan 14 Channel Aftertouch",
    "222": "Chan 15 Channel Aftertouch",
    "223": "Chan 16 Channel Aftertouch",
    "224": "Chan 1 Pitch Bend Change",
    "225": "Chan 2 Pitch Bend Change",
    "226": "Chan 3 Pitch Bend Change",
    "227": "Chan 4 Pitch Bend Change",
    "228": "Chan 5 Pitch Bend Change",
    "229": "Chan 6 Pitch Bend Change",
    "230": "Chan 7 Pitch Bend Change",
    "231": "Chan 8 Pitch Bend Change",
    "232": "Chan 9 Pitch Bend Change",
    "233": "Chan 10 Pitch Bend Change",
    "234": "Chan 11 Pitch Bend Change",
    "235": "Chan 12 Pitch Bend Change",
    "236": "Chan 13 Pitch Bend Change",
    "237": "Chan 14 Pitch Bend Change",
    "238": "Chan 15 Pitch Bend Change",
    "239": "Chan 16 Pitch Bend Change",
    "240": "System Exclusive",
    "241": "MIDI Time Code Qtr. Frame",
    "242": "Song Position Pointer",
    "243": "Song Select (Song #)",
    "244": "Undefined (Reserved)",
    "245": "Undefined (Reserved)",
    "246": "Tune request",
    "247": "End of SysEx (EOX)",
    "248": "Timing clock",
    "249": "Undefined (Reserved)",
    "250": "Start",
    "251": "Continue",
    "252": "Stop",
    "253": "Undefined (Reserved)",
    "254": "Active Sensing",
    "255": "System Reset",
  },
  "data byte 1": {
    "128": "Note Number (0-127)",
    "129": "Note Number (0-127)",
    "130": "Note Number (0-127)",
    "131": "Note Number (0-127)",
    "132": "Note Number (0-127)",
    "133": "Note Number (0-127)",
    "134": "Note Number (0-127)",
    "135": "Note Number (0-127)",
    "136": "Note Number (0-127)",
    "137": "Note Number (0-127)",
    "138": "Note Number (0-127)",
    "139": "Note Number (0-127)",
    "140": "Note Number (0-127)",
    "141": "Note Number (0-127)",
    "142": "Note Number (0-127)",
    "143": "Note Number (0-127)",
    "144": "Note Number (0-127)",
    "145": "Note Number (0-127)",
    "146": "Note Number (0-127)",
    "147": "Note Number (0-127)",
    "148": "Note Number (0-127)",
    "149": "Note Number (0-127)",
    "150": "Note Number (0-127)",
    "151": "Note Number (0-127)",
    "152": "Note Number (0-127)",
    "153": "Note Number (0-127)",
    "154": "Note Number (0-127)",
    "155": "Note Number (0-127)",
    "156": "Note Number (0-127)",
    "157": "Note Number (0-127)",
    "158": "Note Number (0-127)",
    "159": "Note Number (0-127)",
    "160": "Note Number (0-127)",
    "161": "Note Number (0-127",
    "162": "Note Number (0-127",
    "163": "Note Number (0-127",
    "164": "Note Number (0-127",
    "165": "Note Number (0-127",
    "166": "Note Number (0-127",
    "167": "Note Number (0-127",
    "168": "Note Number (0-127",
    "169": "Note Number (0-127",
    "170": "Note Number (0-127",
    "171": "Note Number (0-127",
    "172": "Note Number (0-127",
    "173": "Note Number (0-127",
    "174": "Note Number (0-127",
    "175": "Note Number (0-127",
    "176": "see Table 3",
    "177": "see Table 3",
    "178": "see Table 3",
    "179": "see Table 3",
    "180": "see Table 3",
    "181": "see Table 3",
    "182": "see Table 3",
    "183": "see Table 3",
    "184": "see Table 3",
    "185": "see Table 3",
    "186": "see Table 3",
    "187": "see Table 3",
    "188": "see Table 3",
    "189": "see Table 3",
    "190": "see Table 3",
    "191": "see Table 3",
    "192": "Program # (0-127)",
    "193": "Program # (0-127)",
    "194": "Program # (0-127)",
    "195": "Program # (0-127)",
    "196": "Program # (0-127)",
    "197": "Program # (0-127)",
    "198": "Program # (0-127)",
    "199": "Program # (0-127)",
    "200": "Program # (0-127)",
    "201": "Program # (0-127)",
    "202": "Program # (0-127)",
    "203": "Program # (0-127)",
    "204": "Program # (0-127)",
    "205": "Program # (0-127)",
    "206": "Program # (0-127)",
    "207": "Program # (0-127)",
    "208": "Pressure (0-127)",
    "209": "Pressure (0-127)",
    "210": "Pressure (0-127)",
    "211": "Pressure (0-127)",
    "212": "Pressure (0-127)",
    "213": "Pressure (0-127)",
    "214": "Pressure (0-127)",
    "215": "Pressure (0-127)",
    "216": "Pressure (0-127)",
    "217": "Pressure (0-127)",
    "218": "Pressure (0-127)",
    "219": "Pressure (0-127)",
    "220": "Pressure (0-127)",
    "221": "Pressure (0-127)",
    "222": "Pressure (0-127)",
    "223": "Pressure (0-127)",
    "224": "Pitch Bender LSB (0-127)",
    "225": "Pitch Bender LSB (0-127)",
    "226": "Pitch Bender LSB (0-127)",
    "227": "Pitch Bender LSB (0-127)",
    "228": "Pitch Bender LSB (0-127)",
    "229": "Pitch Bender LSB (0-127)",
    "230": "Pitch Bender LSB (0-127)",
    "231": "Pitch Bender LSB (0-127)",
    "232": "Pitch Bender LSB (0-127)",
    "233": "Pitch Bender LSB (0-127)",
    "234": "Pitch Bender LSB (0-127)",
    "235": "Pitch Bender LSB (0-127)",
    "236": "Pitch Bender LSB (0-127)",
    "237": "Pitch Bender LSB (0-127)",
    "238": "Pitch Bender LSB (0-127)",
    "239": "Pitch Bender LSB (0-127)",
    "240": "**",
    "241": "-see spec-",
    "242": "LSB",
    "243": "(0-127)",
    "244": "---",
    "245": "---",
    "246": "none",
    "247": "none",
    "248": "none",
    "249": "---",
    "250": "none",
    "251": "none",
    "252": "none",
    "253": "---",
    "254": "none",
    "255": "none",
  },
  "data byte 3": {
    "128": "Note Velocity (0-127)",
    "129": "Note Velocity (0-127)",
    "130": "Note Velocity (0-127)",
    "131": "Note Velocity (0-127)",
    "132": "Note Velocity (0-127)",
    "133": "Note Velocity (0-127)",
    "134": "Note Velocity (0-127)",
    "135": "Note Velocity (0-127)",
    "136": "Note Velocity (0-127)",
    "137": "Note Velocity (0-127)",
    "138": "Note Velocity (0-127)",
    "139": "Note Velocity (0-127)",
    "140": "Note Velocity (0-127)",
    "141": "Note Velocity (0-127)",
    "142": "Note Velocity (0-127)",
    "143": "Note Velocity (0-127)",
    "144": "Note Velocity (0-127)",
    "145": "Note Velocity (0-127)",
    "146": "Note Velocity (0-127)",
    "147": "Note Velocity (0-127)",
    "148": "Note Velocity (0-127)",
    "149": "Note Velocity (0-127)",
    "150": "Note Velocity (0-127)",
    "151": "Note Velocity (0-127)",
    "152": "Note Velocity (0-127)",
    "153": "Note Velocity (0-127)",
    "154": "Note Velocity (0-127)",
    "155": "Note Velocity (0-127)",
    "156": "Note Velocity (0-127)",
    "157": "Note Velocity (0-127)",
    "158": "Note Velocity (0-127)",
    "159": "Note Velocity (0-127)",
    "160": "Pressure (0-127)",
    "161": "Pressure (0-127)",
    "162": "Pressure (0-127)",
    "163": "Pressure (0-127)",
    "164": "Pressure (0-127)",
    "165": "Pressure (0-127)",
    "166": "Pressure (0-127)",
    "167": "Pressure (0-127)",
    "168": "Pressure (0-127)",
    "169": "Pressure (0-127)",
    "170": "Pressure (0-127)",
    "171": "Pressure (0-127)",
    "172": "Pressure (0-127)",
    "173": "Pressure (0-127)",
    "174": "Pressure (0-127)",
    "175": "Pressure (0-127)",
    "176": "see Table 3",
    "177": "see Table 3",
    "178": "see Table 3",
    "179": "see Table 3",
    "180": "see Table 3",
    "181": "see Table 3",
    "182": "see Table 3",
    "183": "see Table 3",
    "184": "see Table 3",
    "185": "see Table 3",
    "186": "see Table 3",
    "187": "see Table 3",
    "188": "see Table 3",
    "189": "see Table 3",
    "190": "see Table 3",
    "191": "see Table 3",
    "192": "none",
    "193": "none",
    "194": "none",
    "195": "none",
    "196": "none",
    "197": "none",
    "198": "none",
    "199": "none",
    "200": "none",
    "201": "none",
    "202": "none",
    "203": "none",
    "204": "none",
    "205": "none",
    "206": "none",
    "207": "none",
    "208": "none",
    "209": "none",
    "210": "none",
    "211": "none",
    "212": "none",
    "213": "none",
    "214": "none",
    "215": "none",
    "216": "none",
    "217": "none",
    "218": "none",
    "219": "none",
    "220": "none",
    "221": "none",
    "222": "none",
    "223": "none",
    "224": "Pitch Bender MSB (0-127)",
    "225": "Pitch Bender MSB (0-127)",
    "226": "Pitch Bender MSB (0-127)",
    "227": "Pitch Bender MSB (0-127)",
    "228": "Pitch Bender MSB (0-127)",
    "229": "Pitch Bender MSB (0-127)",
    "230": "Pitch Bender MSB (0-127)",
    "231": "Pitch Bender MSB (0-127)",
    "232": "Pitch Bender MSB (0-127)",
    "233": "Pitch Bender MSB (0-127)",
    "234": "Pitch Bender MSB (0-127)",
    "235": "Pitch Bender MSB (0-127)",
    "236": "Pitch Bender MSB (0-127)",
    "237": "Pitch Bender MSB (0-127)",
    "238": "Pitch Bender MSB (0-127)",
    "239": "Pitch Bender MSB (0-127)",
    "240": "**",
    "241": "-see spec-",
    "242": "MSB",
    "243": "none",
    "244": "---",
    "245": "---",
    "246": "none",
    "247": "none",
    "248": "none",
    "249": "---",
    "250": "none",
    "251": "none",
    "252": "none",
    "253": "---",
    "254": "none",
    "255": "none",
  },
};

/**
 * Interface that connects and works with the external MIDI input device
 */
export class PhysicalPiano {
  midi: WebMidi.MIDIAccess;

  /**
   * Set up and configure external MIDI input device to be interfaced
   * @constructor
   */
  constructor() {
    this.requestMIDIAccess().then(
      (midi) => {
        this.midi = midi;
      },
      () => {
        console.error("MIDI devices not allowed or detected");
      }
    );
  }

  /**
   * Try to get access to the physical MIDI device
   *
   * @returns a promise to when a MIDI device is connected
   */
  requestMIDIAccess(): Promise<WebMidi.MIDIAccess> {
    if (!navigator.requestMIDIAccess) {
      console.error("MIDI is not supported in this browser");
      return undefined;
    } else {
      return navigator.requestMIDIAccess();
    }
  }

  /**
   * Will enable messages for any input given from the physical MIDI device.
   */
  debugMIDI() {
    function onMIDIMessage(message) {
      console.log(message.data);
    }

    const inputs = this.midi.inputs.values();
    for (
      let input = inputs.next();
      input && !input.done;
      input = inputs.next()
    ) {
      // each time there is a midi message call the onMIDIMessage function
      input.value.onmidimessage = onMIDIMessage;
    }
  }

  listenValue() {
    const inputs = this.midi.inputs.values();
    const body = document.body;
    const newElement = document.createElement("div");
    body.appendChild(newElement);
    for (
      let input = inputs.next();
      input && !input.done;
      input = inputs.next()
    ) {
      // each time there is a midi message call the onMIDIMessage function
      input.value.onmidimessage = (message) => {
        newElement.textContent = JSON.stringify(this.parseMidiMessage(message));
      };
    }
  }

  /**
   * Parse basic information out of a MIDI message.
   */
  parseMidiMessage(message, debug = false) {
    if (debug) this.debugMidiMessageType(message);

    return {
      command: message.data[0].toString(16),
      channel: (message.data[0] & 0xf) + 1, // To display channels starting at 1
      note: message.data[1],
      velocity: message.data[2] / 127,
    };
  }

  debugMidiMessageType(message) {
    console.log(StatusBytes.function[message.data[0].toString()]);
  }
}
